<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Moderated Forum</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#0e0e0e;color:#eaeaea;font-family:Arial,sans-serif;
  margin:0;padding:0
}
header{
  padding:15px 20px;
  border-bottom:1px solid #333;
}
nav a{
  margin-right:14px;
  color:#7cf;
  cursor:pointer;
  text-decoration:none;
}
nav a:hover{text-decoration:underline}
main{
  max-width:1100px;
  margin:auto;
  padding:20px;
}
input,textarea{
  width:100%;
  padding:10px;
  margin:6px 0;
  background:#1a1a1a;
  color:#fff;
  border:1px solid #333
}
button{
  padding:8px 14px;
  background:#333;
  color:#fff;
  border:none;
  cursor:pointer
}
button:hover{background:#444}
.page{display:none}
.post{
  border-bottom:1px solid #333;
  padding:12px 0
}
.user{color:#7cf;font-weight:bold}
.small{font-size:12px;color:#888}
.preview img, .preview audio{
  max-width:300px;
  display:block;
  margin-top:8px
}
.hidden{display:none}
</style>
</head>

<body>

<header>
  <nav>
    <a onclick="show('forum')">Forum</a>
    <a onclick="show('guidelines')">Guidelines</a>
    <a onclick="show('profile')">Profile</a>
    <a onclick="show('appeals')">Appeals</a>
    <a onclick="show('login')" id="loginLink">Login</a>
    <a onclick="logout()" id="logoutLink" class="hidden">Logout</a>
  </nav>
</header>

<main>

<!-- LOGIN -->
<div id="login" class="page">
  <h2>Login</h2>
  <input id="lu" placeholder="Username">
  <input id="lp" type="password" placeholder="Password">
  <button onclick="login()">Login</button>

  <h3>Sign up</h3>
  <input id="su" placeholder="Username">
  <input id="sp" type="password" placeholder="Password">
  <button onclick="signup()">Create account</button>

  <p id="authMsg" class="small"></p>
</div>

<!-- FORUM -->
<div id="forum" class="page">
  <h2>Forum</h2>

  <textarea id="postContent" placeholder="Write something..."></textarea>

  <input type="file" id="fileInput" accept="image/*,audio/*">
  <div class="preview" id="preview"></div>

  <label>
    <input type="checkbox" id="anon"> Post anonymously
  </label><br><br>

  <button onclick="createPost()">Post</button>

  <hr>
  <div id="posts"><p class="small">Loading postsâ€¦</p></div>
</div>

<!-- PROFILE -->
<div id="profile" class="page">
  <h2>Profile</h2>
  <p><b>Username:</b> <span id="pName"></span></p>
  <p><b>Status:</b> Active</p>
</div>

<!-- GUIDELINES -->
<div id="guidelines" class="page">
  <h2>Forum Guidelines</h2>
  <ul>
    <li>Free discussion allowed</li>
    <li>No ads or spam</li>
    <li><b>No crime or illegal activity</b></li>
    <li>AI moderation runs 24/7</li>
  </ul>
</div>

<!-- APPEALS -->
<div id="appeals" class="page">
  <h2>Appeals</h2>
  <textarea id="appealText" placeholder="Explain your appeal"></textarea>
  <button onclick="submitAppeal()">Submit appeal</button>
</div>

</main>

<script>
let user = JSON.parse(localStorage.getItem("user"));

function show(id){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
}

function updateUI(){
  if(user){
    loginLink.classList.add("hidden");
    logoutLink.classList.remove("hidden");
    pName.textContent = user.username;
    show("forum");
    loadPosts();
  }else{
    loginLink.classList.remove("hidden");
    logoutLink.classList.add("hidden");
    show("login");
  }
}

async function signup(){
  authMsg.textContent="Creating account...";
  const res = await fetch("/.netlify/functions/api",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({action:"signup",u:su.value,p:sp.value})
  });
  authMsg.textContent = res.ok ? "Account created. You can log in." : "Signup failed.";
}

async function login(){
  authMsg.textContent="Logging in...";
  const res = await fetch("/.netlify/functions/api",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({action:"login",u:lu.value,p:lp.value})
  });
  const data = await res.json();
  if(data.ok){
    user=data.user;
    localStorage.setItem("user",JSON.stringify(user));
    updateUI();
  }else{
    authMsg.textContent="Invalid login.";
  }
}

function logout(){
  localStorage.clear();
  user=null;
  updateUI();
}

fileInput.onchange = () => {
  preview.innerHTML="";
  const f = fileInput.files[0];
  if(!f) return;
  if(f.type.startsWith("image")){
    const img=document.createElement("img");
    img.src=URL.createObjectURL(f);
    preview.appendChild(img);
  }
  if(f.type.startsWith("audio")){
    const a=document.createElement("audio");
    a.controls=true;
    a.src=URL.createObjectURL(f);
    preview.appendChild(a);
  }
};

async function createPost(){
  if(!user) return alert("Login required");

  const fd = new FormData();
  fd.append("action","post");
  fd.append("user",anon.checked?"Anonymous":user.username);
  fd.append("content",postContent.value);
  if(fileInput.files[0]) fd.append("file",fileInput.files[0]);

  await fetch("/.netlify/functions/api",{ method:"POST", body:fd });

  postContent.value="";
  fileInput.value="";
  preview.innerHTML="";
  loadPosts();
}

async function loadPosts(){
  const r = await fetch("/.netlify/functions/api");
  const posts = await r.json();
  document.getElementById("posts").innerHTML = posts.map(p=>`
    <div class="post">
      <span class="user">${p.user}</span>
      <p>${p.content}</p>
      ${p.file_url ? (
        p.file_type.startsWith("image")
        ? `<img src="${p.file_url}" style="max-width:300px">`
        : `<audio controls src="${p.file_url}"></audio>`
      ) : ""}
    </div>
  `).join("");
}

async function submitAppeal(){
  await fetch("/.netlify/functions/api",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({action:"appeal",text:appealText.value})
  });
  appealText.value="";
  alert("Appeal submitted");
}

updateUI();
</script>

</body>
</html>
